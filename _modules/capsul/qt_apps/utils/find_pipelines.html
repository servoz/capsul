
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
  
    <title>CAPSUL &mdash; CAPSUL - Collaborative Analysis Platform: Simple, Unifying, Lean</title>
  <!-- htmltitle is before nature.css - we use this hack to load bootstrap first -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../../../../_static/css/bootstrap.min.css" media="screen" />
  <link rel="stylesheet" href="../../../../_static/css/bootstrap-responsive.css"/>

    
    <link rel="stylesheet" href="../../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="CAPSUL - Collaborative Analysis Platform: Simple, Unifying, Lean" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" />
  
   
       <script type="text/javascript" src="../../../../_static/sidebar.js"></script>
   
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="../../../../_static/js/bootstrap.min.js" type="text/javascript"></script>
  <!-- <link rel="canonical" href="https://bioproj.extra.cea.fr/redmine/projects/nsap/_modules/capsul/qt_apps/utils/find_pipelines.html" /> -->

  <script type="text/javascript">
    $("div.buttonNext, div.buttonPrevious").hover(
       function () {
           $(this).css('background-color', '#FF9C34');
       },
       function () {
           $(this).css('background-color', '#A7D6E2');
       }
    );
    var bodywrapper = $('.bodywrapper');
    var sidebarbutton = $('#sidebarbutton');
    sidebarbutton.css({'height': '900px'});
  </script>

  </head>
  <body>

<div class="header-wrapper">
  <div class="header">
    <p class="logo">
      <a href="../../../../index.html">
        <img src="../../../../_static/capsul.png" alt="Logo"/>
      </a>
    </p><div class="navbar">
      <ul>
        <li><a href="../../../../index.html">Home</a></li>
        <li><a href="../../../../installation.html">Installation</a></li>
        <li class="btn-li">
          <div class="btn-group">
		    <a href="../../../../documentation.html">Documentation</a>
		    <a class="btn dropdown-toggle" data-toggle="dropdown">
		      <span class="caret"></span>
		    </a>
		    <ul class="dropdown-menu">
	          <li class="link-title">CAPSUL</li>
			  <li><a href="../../../../user_guide_tree/index.html">User guide</a></li>
			  <li><a href="../../../../api_tree/index.html">API</a></li>
			  <li><a href="../../../../gui_tree/index.html">GUI</a></li>
			  <li class="divider"></li>
		      <li><a href="../../../../developer_tree/index.html">Development</a></li>
		    </ul>
		  </div>
        </li>
        <li><a href="http://neurospin-wiki.org/">NeuroSpin Wiki</a></li>
      </ul>
    </div> <!-- end navbar --></div>
</div>


<div class="content-wrapper">
    <div class="sphinxsidebar">
      <div class="sphinxsidebarwrapper">

        <!-- info setup -->
          <p class="doc-version">
           This documentation is for CAPSUL <strong>version 0.0.1</strong>
          </p>
        <p class="citing">
          If you use the software, please do not esitate to 
          <a &mdash; <a href="https://bioproj.extra.cea.fr/redmine/projects/capsul/">
          Report a Bug</a>.
        </p>
        <!-- <form action="/scripts/nsap-src-message.php" method="post">
          <textarea rows="4" name="comments" style="width:175px">Enter here your comments</textarea>
          <center>
           <input type="submit" value="Send">
          </center>
        </form> -->

      <!-- toc tree -->
      

      </div>
    </div>
  

  <div class="content">
      
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for capsul.qt_apps.utils.find_pipelines</h1><div class="highlight"><pre>
<span class="c">#! /usr/bin/env python</span>
<span class="c">##########################################################################</span>
<span class="c"># CAPSUL - Copyright (C) CEA, 2013</span>
<span class="c"># Distributed under the terms of the CeCILL-B license, as published by</span>
<span class="c"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c"># http://www.cecill.info/licences/Licence_CeCILL-B_V1-en.html</span>
<span class="c"># for details.</span>
<span class="c">##########################################################################</span>

<span class="c"># System import</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">find_packages</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">isclass</span>

<span class="c"># Define the logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">find_pipelines_from_description</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function that list all the pipeline of a module.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    module_name: str (mandatory)</span>
<span class="sd">        the name of the module we want to go through in order to find all</span>
<span class="sd">        pipeline classes.</span>
<span class="sd">    url: str (optional)</span>
<span class="sd">        the url to the module documentation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    structured_pipelines: hierachic dict</span>
<span class="sd">        each key is a sub module of the module. Leafs contain a list with</span>
<span class="sd">        the url to the documentation.</span>
<span class="sd">    pipelines: list</span>
<span class="sd">        a list a pipeline string descriptions.        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Try to import the module</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">__import__</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Can&#39;t load module {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{},</span> <span class="p">[]</span>

    <span class="c"># Get the module path</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span>
    <span class="n">module_path</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c"># Build the expected pipeline description file</span>
    <span class="n">description_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">module_path</span><span class="p">,</span> <span class="s">&quot;{0}.capsul&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_name</span><span class="p">))</span>

    <span class="c"># Load the description file</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">description_file</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">description_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="n">pipelines</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

        <span class="c"># Organize the pipeline string description by module names</span>
        <span class="n">structured_pipelines</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">lists2dict</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pipelines</span><span class="p">],</span> <span class="n">url</span><span class="p">,</span> <span class="n">structured_pipelines</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">structured_pipelines</span><span class="p">,</span> <span class="n">pipelines</span>

    <span class="c"># No description found</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{},</span> <span class="p">[]</span>


<div class="viewcode-block" id="find_pipelines"><a class="viewcode-back" href="../../../../gui_tree/generated/capsul-apps-utils/capsul.qt_apps.utils.find_pipelines.find_pipelines.html#capsul.qt_apps.utils.find_pipelines.find_pipelines">[docs]</a><span class="k">def</span> <span class="nf">find_pipelines</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allowed_instance</span><span class="o">=</span><span class="s">&quot;Pipeline&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function that return all the Pipeline class of a module.</span>

<span class="sd">    All the mdoule path are scanned recuresively. Any pipeline will be added</span>
<span class="sd">    to the output.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    module_name: str (mandatory)</span>
<span class="sd">        the name of the module we want to go through in order to find all</span>
<span class="sd">        pipeline classes.</span>
<span class="sd">    url: str (optional)</span>
<span class="sd">        the url to the module documentation</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    structured_pipelines: hierachic dict</span>
<span class="sd">        each key is a sub module of the module. Leafs contain a list with</span>
<span class="sd">        the url to the documentation.</span>
<span class="sd">    pipelines: list</span>
<span class="sd">        a list a pipeline string descriptions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Try to import the module</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">__import__</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Can&#39;t load module {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{},</span> <span class="p">[]</span>

    <span class="c"># Get the module path</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span>
    <span class="n">module_path</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c"># Use setuptools to go through the module</span>
    <span class="n">sub_modules</span> <span class="o">=</span> <span class="n">find_packages</span><span class="p">(</span><span class="n">where</span><span class="o">=</span><span class="n">module_path</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;doc&quot;</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">sub_modules</span> <span class="o">=</span> <span class="p">[</span><span class="n">module_name</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sub_modules</span><span class="p">]</span>
    <span class="n">sub_modules</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">module_name</span><span class="p">)</span>

    <span class="c"># Shift</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">module_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">))</span>

    <span class="c"># Create a set with all pipelines</span>
    <span class="n">pipelines</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">sub_module</span> <span class="ow">in</span> <span class="n">sub_modules</span><span class="p">:</span>
        <span class="c"># Get the sub module path</span>
        <span class="n">sub_module_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">module_path</span><span class="p">,</span>
                                       <span class="o">*</span><span class="n">sub_module</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)[</span><span class="n">shift</span><span class="p">:])</span>

        <span class="c"># List all the mdule in sub module path</span>
        <span class="n">sub_sub_module_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">sub_module</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
                                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">sub_module_path</span><span class="p">)</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.py&quot;</span><span class="p">)</span> <span class="ow">and</span>
                                    <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">))]</span>

        <span class="c"># Try to import the sub sub module</span>
        <span class="k">for</span> <span class="n">sub_sub_module_name</span> <span class="ow">in</span> <span class="n">sub_sub_module_names</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">__import__</span><span class="p">(</span><span class="n">sub_sub_module_name</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">exc_info</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="n">exc_info</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Can&#39;t load module &quot;</span>
                              <span class="s">&quot;{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sub_sub_module_name</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="c"># Get the module</span>
            <span class="n">sub_sub_module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">sub_sub_module_name</span><span class="p">]</span>

            <span class="c"># From all the tools, find Pipeline instance</span>
            <span class="k">for</span> <span class="n">tool_name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">sub_sub_module</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">tool_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">tool</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sub_sub_module</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">isclass</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="n">tool</span><span class="o">.</span><span class="n">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="n">allowed_instance</span> <span class="ow">and</span>
                        <span class="n">tool_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;Pipeline&quot;</span><span class="p">,</span> <span class="s">&quot;ConnProcess&quot;</span><span class="p">]):</span>
                    <span class="n">pipelines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sub_sub_module_name</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">tool_name</span><span class="p">)</span>

    <span class="c"># Organize the pipeline string description by module names</span>
    <span class="n">structured_pipelines</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lists2dict</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pipelines</span><span class="p">],</span> <span class="n">url</span><span class="p">,</span> <span class="n">structured_pipelines</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">structured_pipelines</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">pipelines</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">lists2dict</span><span class="p">(</span><span class="n">list_of_pipeline_description</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convert a list of splited module names to a hierachic dictionary with</span>
<span class="sd">    list leafs that contain the url to the module docuementation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    list_of_pipeline_description: list of list of str (mandatory)</span>
<span class="sd">        the splited module names to organize bu modules</span>
<span class="sd">    url: str (mandatory)</span>
<span class="sd">        the url to the module documentation</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    d: hierachic dict</span>
<span class="sd">        each key is a sub module of the module. Leafs contain a list with</span>
<span class="sd">        the url to the documentation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Go through all pipeline descriptions</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">list_of_pipeline_description</span><span class="p">:</span>

        <span class="c"># Reach a leaf (a pipeline)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span> <span class="ow">or</span> <span class="s">&quot;&quot;</span><span class="p">)</span>

        <span class="c"># Continue the recursion</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">lists2dict</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">:]],</span> <span class="n">url</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lists2dict</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">:]],</span> <span class="n">url</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>

    <span class="k">return</span> <span class="n">d</span>
</pre></div>

          </div>
        </div>
      </div>
    <div class="clearer">
    </div>
  </div>
  
</div>

<div class="footer">
    &copy; 2013, CAPSUL developers &lt;antoine.grigis@cea.fr&gt;.
</div>
  </body>
</html>